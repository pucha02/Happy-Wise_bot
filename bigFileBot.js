import TelegramBot from 'node-telegram-bot-api';
import fs from 'fs'
import path from 'path';
import { mainMenu, startKeyboard, testMenuKeyboard, aboutSchoolMenu, teachersKeyboard, packageKeyboard } from './keyboards.js';
import { teacherDescriptions, sendTeacherInfo } from './sendTeacherInfo.js';
import { sendToKeyCRM } from './sendToKeyCRM.js';
import { sendQuestion } from './sendQuestion.js';
import { setBotCommands } from './setBotCommands.js';
import { questions } from './questionsForTEst.js';

const token = '8093162300:AAERaFyiqaWZn_mkAwtyYtd9epPHNvSFX0s';
const bot = new TelegramBot(token, { polling: true });

setBotCommands(bot);

let currentQuestion = {};
let isTakingTest = {};
let countTrueAnswers = {};

////////////////////// –°—Ç–∞—Ä—Ç
bot.onText(/\/start/, async (msg) => {
  const chatId = msg.chat.id;

  await bot.sendMessage(chatId, '–ü—Ä–∏–≤—ñ—Ç! –Ø –±–æ—Ç-–∞—Å–∏—Å—Ç–µ–Ω—Ç —à–∫–æ–ª–∏ Happy&Wise. –†–∞–¥–∏–π –¥–æ–ø–æ–º–æ–≥—Ç–∏ –≤–∞–º –Ω–∞ —à–ª—è—Ö—É –¥–æ –≤–∏–≤—á–µ–Ω–Ω—è –∞–Ω–≥–ª—ñ–π—Å—å–∫–æ—ó –º–æ–≤–∏!');
  await bot.sendMessage(chatId, "–ú–∏ —Ä–æ–∑—Ä–æ–±–∏–ª–∏ —Å–ø–µ—Ü—ñ–∞–ª—å–Ω—É –º–µ—Ç–æ–¥–∏–∫—É –¥–ª—è –≤–∏–∑–Ω–∞—á–µ–Ω–Ω—è –≤–∞—à–æ–≥–æ —Ä—ñ–≤–Ω—è –≤–æ–ª–æ–¥—ñ–Ω–Ω—è –∞–Ω–≥–ª—ñ–π—Å—å–∫–æ—é, —â–æ–± –ø—ñ–¥—ñ–±—Ä–∞—Ç–∏ –Ω–∞–π–∫—Ä–∞—â–∏–π –ø–ª–∞–Ω –Ω–∞–≤—á–∞–Ω–Ω—è –¥–ª—è –≤–∞—Å. –ù–∞—Å—Ç—É–ø–Ω–∏–º –∫—Ä–æ–∫–æ–º –ø—Ä–æ–ø–æ–Ω—É—é –ø—Ä–æ–π—Ç–∏ –Ω–µ–≤–µ–ª–∏–∫–∏–π —Ç–µ—Å—Ç, –ø—ñ—Å–ª—è —è–∫–æ–≥–æ –≤–∏ –∑–º–æ–∂–µ—Ç–µ –∑–∞–ª–∏—à–∏—Ç–∏ —Å–≤–æ—ó –∫–æ–Ω—Ç–∞–∫—Ç–∏, —ñ –º–∏ –∑–≤'—è–∂–µ–º–æ—Å—è –∑ –≤–∞–º–∏ –¥–ª—è –æ–±–≥–æ–≤–æ—Ä–µ–Ω–Ω—è —Ä–µ–∑—É–ª—å—Ç–∞—Ç—ñ–≤ —Ç–∞ –ø–æ–¥–∞–ª—å—à–∏—Ö –∫—Ä–æ–∫—ñ–≤.");
  await bot.sendMessage(chatId, '–ì–æ—Ç–æ–≤—ñ —Ä–æ–∑–ø–æ—á–∞—Ç–∏ —Ç–µ—Å—Ç?', startKeyboard);
});
////////////////////// –°—Ç–∞—Ä—Ç


////////////////////// –ì–æ–ª–æ–≤–Ω–µ –º–µ–Ω—é
bot.onText(/–ì–æ–ª–æ–≤–Ω–µ –º–µ–Ω—é/, async (msg) => {
  const chatId = msg.chat.id;
  await bot.sendMessage(chatId, '–û–±–∏—Ä–∞–π—Ç–µ –∫–Ω–æ–ø–∫–∞–º–∏, —â–æ —Ü—ñ–∫–∞–≤–∏—Ç—åüëá', mainMenu);
});
////////////////////// –ì–æ–ª–æ–≤–Ω–µ –º–µ–Ω—é

////////////////////// –ü—Ä–æ —à–∫–æ–ª—É
bot.onText(/–ü—Ä–æ —à–∫–æ–ª—É/, async (msg) => {
  const chatId = msg.chat.id;
  await bot.sendMessage(
    chatId, 
    `üè´ <b>Happy&Wise</b> ‚Äî —Ü–µ —Å–ø—ñ–ª—å–Ω–æ—Ç–∞ —â–∞—Å–ª–∏–≤–∏—Ö —Ç–∞ –º—É–¥—Ä–∏—Ö –ª—é–¥–µ–π, —è–∫—ñ –æ–±'—î–¥–Ω–∞–Ω—ñ —Å–ø—ñ–ª—å–Ω–æ—é –º—ñ—Å—ñ—î—é ‚Äî —Å—Ç–≤–æ—Ä–∏—Ç–∏ –≤ –£–∫—Ä–∞—ó–Ω—ñ –∞–Ω–≥–ª–æ–º–æ–≤–Ω–µ —Å—É—Å–ø—ñ–ª—å—Å—Ç–≤–æ.\n\nüéØ –ù–∞—à–∞ —î–¥–∏–Ω–∞ —Ü—ñ–ª—å ‚Äî –ø—Ä–æ–∫–∞—á–∞—Ç–∏ –≤–∞—à—É <b>–†–û–ó–ú–û–í–ù–£ –ê–Ω–≥–ª—ñ–π—Å—å–∫—É</b>!`,
    {
      parse_mode: 'HTML',
      reply_markup: aboutSchoolMenu
    }
  );
});

////////////////////// –ü—Ä–æ —à–∫–æ–ª—É

////////////////////// –§–æ—Ä–º–∞—Ç–∏ –Ω–∞–≤—á–∞–Ω–Ω—è
bot.onText(/–§–æ—Ä–º–∞—Ç–∏ –Ω–∞–≤—á–∞–Ω–Ω—è/, async (msg) => {
  const chatId = msg.chat.id;
  await bot.sendMessage(
    chatId, 
    `üéì <b>–ê–Ω–≥–ª—ñ–π—Å—å–∫–∞ —è–∫ —Å–ø–æ—Å—ñ–± –∂–∏—Ç—Ç—è</b>\n\nüåü <b>–†–æ–∑–º–æ–≤–Ω–∞ –∞–Ω–≥–ª—ñ–π—Å—å–∫–∞ ‚Äî –Ω–∞—à –ø—Ä—ñ–æ—Ä–∏—Ç–µ—Ç!</b> –ü—Ä–∞–∫—Ç–∏–∫–∞ —Ä–æ–∑–º–æ–≤ —É —Ä—ñ–∑–Ω–∏—Ö —Ñ–æ—Ä–º–∞—Ç–∞—Ö:\n
    - üë• <b>–ì—Ä—É–ø–æ–≤—ñ / –ø–∞—Ä–Ω—ñ / —ñ–Ω–¥–∏–≤—ñ–¥—É–∞–ª—å–Ω—ñ –∑–∞–Ω—è—Ç—Ç—è</b> –Ω–∞ –Ω–∞–≤—á–∞–ª—å–Ω—ñ–π –ø–ª–∞—Ç—Ñ–æ—Ä–º—ñ –∑ –≤–∏–∫–ª–∞–¥–∞—á–µ–º\n
    - üåç <b>–ó–∞–Ω—è—Ç—Ç—è –∑ –Ω–æ—Å—ñ—è–º–∏ –º–æ–≤–∏</b>\n
    - üó£Ô∏è <b>Speaking Club</b> ‚Äî —â–æ—Å—É–±–æ—Ç–∏ –æ 10:00\n
    - üí¨ <b>–†–æ–∑–º–æ–≤–Ω—ñ —á–µ–ª–µ–Ω–¥–∂—ñ</b> ‚Äî —â–æ–º—ñ—Å—è—Ü—è`,
    { parse_mode: 'HTML' }  // –£–∫–∞–∑—ã–≤–∞–µ–º, —á—Ç–æ –∏—Å–ø–æ–ª—å–∑—É–µ–º HTML
  );
});
////////////////////// –§–æ—Ä–º–∞—Ç–∏ –Ω–∞–≤—á–∞–Ω–Ω—è

////////////////////// –ü–µ—Ä–µ–≤–∞–≥–∏ –Ω–∞–≤—á–∞–Ω–Ω—è –∑ –Ω–∞–º–∏
bot.onText(/–ü–µ—Ä–µ–≤–∞–≥–∏ –Ω–∞–≤—á–∞–Ω–Ω—è –∑ –Ω–∞–º–∏/, async (msg) => {
  const chatId = msg.chat.id;
  await bot.sendMessage(
    chatId, 
    `üåü **–§–æ–∫—É—Å –Ω–∞ —Ä–æ–∑–º–æ–≤–Ω—ñ–π –∞–Ω–≥–ª—ñ–π—Å—å–∫—ñ–π**\n
    –ù–∞—à–∞ –ø–ª–∞—Ç—Ñ–æ—Ä–º–∞ —Å—Ç–≤–æ—Ä–µ–Ω–∞, —â–æ–± —Ç–µ–±–µ —Ä–æ–∑–≥–æ–≤–æ—Ä–∏—Ç–∏. –ê–ª–µ –π –≥—Ä–∞–º–∞—Ç–∏–∫–∞ –±—É–¥–µ –æ–±–æ–≤'—è–∑–∫–æ–≤–æ, –±–µ–∑ –Ω–µ—ó –Ω–µ–º–æ–∂–ª–∏–≤–æ –≥—Ä–∞–º–æ—Ç–Ω–æ –≥–æ–≤–æ—Ä–∏—Ç–∏.\n

    üß† **–ú—É–¥—Ä—ñ —É —Å–≤–æ—î–º—É –ø—ñ–¥—Ö–æ–¥—ñ –¥–æ –Ω–∞–≤—á–∞–Ω–Ω—è**\n
    –ó–Ω–∞—î–º–æ, —â–æ –ø–æ—Ç—Ä—ñ–±–Ω–æ –ø—Ä–æ–ø—Ä–∞—Ü—é–≤–∞—Ç–∏, —â–æ–± –≤–∏ –∑–∞–≥–æ–≤–æ—Ä–∏–ª–∏ —ñ –Ω–µ –±–æ—è–ª–∏—Å—è –ø—Ä–æ—è–≤–ª—è—Ç–∏—Å—è –∞–Ω–≥–ª—ñ–π—Å—å–∫–æ—é.\n

    üòä **–©–∞—Å–ª–∏–≤—ñ, –∫–æ–ª–∏ –Ω–∞—à—ñ —Å—Ç—É–¥–µ–Ω—Ç–∏ –ø–æ—á–∏–Ω–∞—é—Ç—å –≥–æ–≤–æ—Ä–∏—Ç–∏**\n
    90% –∑–∞–Ω—è—Ç—Ç—è –¢–ò –±—É–¥–µ—à –≥–æ–≤–æ—Ä–∏—Ç–∏.\n

    üíª **–ù–∞–≤—á–∞—î–º–æ—Å—å –Ω–∞ –ø–ª–∞—Ç—Ñ–æ—Ä–º—ñ**\n
    –ù–∞–≤—á–∞–π—Å—è –∑ –±—É–¥—å-—è–∫–æ–≥–æ –≥–∞–¥–∂–µ—Ç—É. –ú–∞—Ç–µ—Ä—ñ–∞–ª —Å—Ç—Ä—É–∫—Ç—É—Ä–æ–≤–∞–Ω–∏–π —Ç–∞ —ñ–Ω—Ç–µ—Ä–∞–∫—Ç–∏–≤–Ω–∏–π. –í–∏–∫–æ—Ä–∏—Å—Ç–æ–≤—É—î–º–æ –º–µ—Ç–æ–¥ –ø–µ—Ä–µ–≤–µ—Ä–Ω—É—Ç–æ–≥–æ —É—Ä–æ–∫—É: —Å—Ç—É–¥–µ–Ω—Ç–∏ –î–û –∑–∞–Ω—è—Ç—Ç—è –≤—á–∞—Ç—å —Å–ª–æ–≤–∞, –∞ –Ω–µ –ø—ñ—Å–ª—è; —Ü–µ –¥–∞—î –∑–º–æ–≥—É –ø–æ–ø—Ä–∞–∫—Ç–∏–∫—É–≤–∞—Ç–∏ –∑ –≤–∏–∫–ª–∞–¥–∞—á–µ–º –ø–æ—Ç—Ä—ñ–±–Ω—É –ª–µ–∫—Å–∏–∫—É –æ–¥—Ä–∞–∑—É –Ω–∞ –∑–∞–Ω—è—Ç—Ç—ñ.\n

    üåà **–ë–µ–∑–ø–µ—á–Ω–∏–π –ø—Ä–æ—Å—Ç—ñ—Ä, –¥–µ –º–æ–∂–Ω–∞ –ø–æ–º–∏–ª—è—Ç–∏—Å—è**\n
    –ü–æ–º–∏–ª—è—Ç–∏—Å—å ‚Äî —Ü–µ –û–ö. –©–æ–± —Ä–æ–∑–≥–æ–≤–æ—Ä–∏—Ç–∏—Å—è, –ø–æ—Ç—Ä—ñ–±–Ω–æ –≤–∏–≥–æ–≤–æ—Ä—é–≤–∞—Ç–∏ –ø–æ–º–∏–ª–∫–∏, —â–æ—Ä–∞–∑—É –ø–æ–∫—Ä–∞—â—É—é—á–∏ —Å–≤—ñ–π —Ä—ñ–≤–µ–Ω—å.\n

    ‚è≥ **–ó–Ω–∞—î–º–æ, —è–∫ –∑–Ω–∞–π—Ç–∏ —á–∞—Å –Ω–∞ –∞–Ω–≥–ª—ñ–π—Å—å–∫—É**\n
    –ü–æ–¥—ñ–ª–∏–º–æ—Å—å —Å–µ–∫—Ä–µ—Ç–∞–º–∏ –µ—Ñ–µ–∫—Ç–∏–≤–Ω–æ–≥–æ –ø–ª–∞–Ω—É–≤–∞–Ω–Ω—è —á–∞—Å—É. –ü–æ–≤—ñ—Ä, —Ä—ñ–≤–µ–Ω—å —â–∞—Å—Ç—è –≤ —Ç–≤–æ—î–º—É –∂–∏—Ç—Ç—ñ —Ç–æ—á–Ω–æ –∑—Ä–æ—Å—Ç–µ!`
  );
});
////////////////////// –ü–µ—Ä–µ–≤–∞–≥–∏ –Ω–∞–≤—á–∞–Ω–Ω—è –∑ –Ω–∞–º–∏

////////////////////// –ß–∞—Å—Ç—ñ –∑–∞–ø–∏—Ç–∞–Ω–Ω—è
bot.onText(/–ß–∞—Å—Ç—ñ –∑–∞–ø–∏—Ç–∞–Ω–Ω—è/, async (msg) => {
  const chatId = msg.chat.id;
  await bot.sendMessage(
    chatId, 
    `‚ùì **–Ø–∫–∏–π —Ñ–æ—Ä–º–∞—Ç –∫—Ä–∞—â–µ: –≥—Ä—É–ø–æ–≤—ñ, –ø–∞—Ä–Ω—ñ —á–∏ —ñ–Ω–¥–∏–≤—ñ–¥—É–∞–ª—å–Ω—ñ?**\n
    –í—Å–µ –∑–∞–ª–µ–∂–∏—Ç—å –≤—ñ–¥ —Ç–≤–æ—î—ó —Ü—ñ–ª—ñ: —è–∫—â–æ —Ö–æ—á–µ—à –±—ñ–ª—å—à–µ –≥–æ–≤–æ—Ä–∏—Ç–∏ ‚Äî –æ–±–∏—Ä–∞–π –≥—Ä—É–ø–æ–≤—ñ –∞–±–æ –ø–∞—Ä–Ω—ñ –∑–∞–Ω—è—Ç—Ç—è. –Ø–∫—â–æ –º–∞—î—à —Å–ø–µ—Ü–∑–∞–ø–∏—Ç —Ç–∞ –æ–±–º–µ–∂–µ–Ω–∏–π —á–∞—Å –¥–ª—è –≤–∏–≤—á–µ–Ω–Ω—è ‚Äî –æ–±–∏—Ä–∞–π —ñ–Ω–¥–∏–≤—ñ–¥—É–∞–ª—å–Ω–∏–π —Ñ–æ—Ä–º–∞—Ç.\n\n

    üë• **–Ø–∫ –≤—ñ–¥–±—É–≤–∞—é—Ç—å—Å—è –≥—Ä—É–ø–æ–≤—ñ –∑–∞–Ω—è—Ç—Ç—è?**\n
    –ó–∞–Ω—è—Ç—Ç—è —Ç—Ä–∏–≤–∞—Ç–∏–º–µ 55 —Ö–≤ —É –º—ñ–Ω—ñ-–≥—Ä—É–ø—ñ –¥–æ 5-6 —Å—Ç—É–¥–µ–Ω—Ç—ñ–≤ –∑ –æ–¥–Ω–∞–∫–æ–≤–∏–º —Ä—ñ–≤–Ω–µ–º –≤–æ–ª–æ–¥—ñ–Ω–Ω—è –º–æ–≤–æ—é, —â–æ–± –≤—Å—ñ–º –±—É–ª–æ –∫–æ–º—Ñ–æ—Ä—Ç–Ω–æ. –ù–∞ –∑–∞–Ω—è—Ç—Ç—è—Ö –≤–∏ –±—É–¥–µ—Ç–µ –ø—Ä–æ–ø—Ä–∞—Ü—å–æ–≤—É–≤–∞—Ç–∏ –≤—Å—ñ –∞—Å–ø–µ–∫—Ç–∏ –º–æ–≤–ª–µ–Ω–Ω—è: –≥—Ä–∞–º–∞—Ç–∏–∫—É, –ª–µ–∫—Å–∏–∫—É, –≥–æ–≤–æ—Ä—ñ–Ω–Ω—è, –Ω–∞–≤–∏—á–∫–∏ —Å–ø—Ä–∏–π–Ω—è—Ç—Ç—è –Ω–∞ —Å–ª—É—Ö —ñ –ø–∏—Å—å–º–æ. –ê–ª–µ –Ω–∞–π–±—ñ–ª—å—à–µ –≤–∏ –±—É–¥–µ—Ç–µ –≥–æ–≤–æ—Ä–∏—Ç–∏! –ú–∏ –¥–±–∞—î–º–æ, —â–æ–± –≤–∏ –æ—Ç—Ä–∏–º–∞–ª–∏ —Ä–µ–∑—É–ª—å—Ç–∞—Ç —è–∫—ñ—Å–Ω–æ —ñ –Ω–∞–∑–∞–≤–∂–¥–∏.\n\n

    ‚ùå **–Ø–∫ —è –º–æ–∂—É —Å–∫–∞—Å—É–≤–∞—Ç–∏ –ø—ñ–¥–ø–∏—Å–∫—É?**\n
    –ù–∞—à –∞–¥–º—ñ–Ω—ñ—Å—Ç—Ä–∞—Ç–æ—Ä –¥–æ–ø–æ–º–æ–∂–µ –ø—Ä–∏–∑—É–ø–∏–Ω–∏—Ç–∏ –∞–±–æ —Å–∫–∞—Å—É–≤–∞—Ç–∏ –ø—ñ–¥–ø–∏—Å–∫—É —É —Ä–∞–∑—ñ –ø–æ—Ç—Ä–µ–±–∏.`
  );
});
////////////////////// –ß–∞—Å—Ç—ñ –∑–∞–ø–∏—Ç–∞–Ω–Ω—è

////////////////////// –í—ñ–¥–≥—É–∫–∏
bot.onText(/–í—ñ–¥–≥—É–∫–∏/, async (msg) => {
  const chatId = msg.chat.id;

  const photos = [
    'images/image.png',
    'images/v2.webp',
    'images/v3.webp',
    'images/v4.webp',
    'images/v5.webp',
    'images/v6.webp',
    'images/v7.webp',
    'images/v8.webp',
    'images/v9.webp'
  ];

  for (const photo of photos) {
    if (!fs.existsSync(photo)) {
      console.error(`–§–∞–π–ª –Ω–µ –Ω–∞–π–¥–µ–Ω: ${photo}`);
      continue;
    }

    const photoStream = fs.createReadStream(photo);
    try {
      await bot.sendPhoto(chatId, photoStream);
    } catch (error) {
      console.error('–û—à–∏–±–∫–∞ –ø—Ä–∏ –æ—Ç–ø—Ä–∞–≤–∫–µ —Ñ–æ—Ç–æ:', error);
    }
  }
  await bot.sendMessage(chatId, '–ë—ñ–ª—å—à–µ –≤—ñ–¥–≥—É–∫—ñ–≤ –≤–∏ –∑–º–æ–∂–µ—Ç–µ –∑–Ω–∞–π—Ç–∏ –Ω–∞ –Ω–∞—à–æ–º—É —Å–∞–π—Ç—ñ - https://happyandwise.wayforpay.shop/');

});
////////////////////// –í—ñ–¥–≥—É–∫–∏

////////////////////// –í—á–∏—Ç–µ–ª—ñ
// –û–±—Ä–æ–±–Ω–∏–∫ –¥–ª—è –ø–æ–∫–∞–∑—É —Å–ø–∏—Å–∫—É –≤—á–∏—Ç–µ–ª—ñ–≤
bot.onText(/–ù–∞—à—ñ –≤—á–∏—Ç–µ–ª—ñ/, async (msg) => {
  const chatId = msg.chat.id;

  // –í—ñ–¥–ø—Ä–∞–≤–ª—è—î–º–æ –∫–ª–∞–≤—ñ–∞—Ç—É—Ä—É –∑ –≤–∏–±–æ—Ä–æ–º –≤—á–∏—Ç–µ–ª—ñ–≤
  await bot.sendMessage(chatId, '–ë—É–¥—å –ª–∞—Å–∫–∞, –æ–±–µ—Ä—ñ—Ç—å –≤–∏–∫–ª–∞–¥–∞—á–∞ –∑—ñ —Å–ø–∏—Å–∫—Éüëá', teachersKeyboard);
});

// –û–±—Ä–æ–±–Ω–∏–∫ –¥–ª—è –≤—ñ–¥—Å—Ç–µ–∂–µ–Ω–Ω—è –≤–∏–±–æ—Ä—É –≤—á–∏—Ç–µ–ª—è
bot.on('message', async (msg) => {
  const chatId = msg.chat.id;
  const teacherName = msg.text.trim(); // –û—á–∏—â—É—î–º–æ —Ç–µ–∫—Å—Ç –≤—ñ–¥ –∑–∞–π–≤–∏—Ö –ø—Ä–æ–±—ñ–ª—ñ–≤

  // –Ø–∫—â–æ —ñ–º'—è –≤—á–∏—Ç–µ–ª—è —î –≤ —Å–ø–∏—Å–∫—É, –≤—ñ–¥–ø—Ä–∞–≤–ª—è—î–º–æ —Ñ–æ—Ç–æ —ñ –æ–ø–∏—Å
  if (teacherDescriptions[teacherName]) {
    sendTeacherInfo(chatId, teacherName, bot);
  }
});
////////////////////// –í—á–∏—Ç–µ–ª—ñ

////////////////////// –ù–∞–≤—á–∞–Ω–Ω—è
bot.onText(/–ù–∞–≤—á–∞–Ω–Ω—è/, async (msg) => {
  const chatId = msg.chat.id;

  // –í—ñ–¥–ø—Ä–∞–≤–ª—è—î–º–æ –∫–ª–∞–≤—ñ–∞—Ç—É—Ä—É –∑ –≤–∏–±–æ—Ä–æ–º –≤—á–∏—Ç–µ–ª—ñ–≤
  await bot.sendMessage(chatId, '–ë—É–¥—å –ª–∞—Å–∫–∞, –æ–±–µ—Ä—ñ—Ç—å –ø–∞–∫–µ—Ç –∑—ñ —Å–ø–∏—Å–∫—Éüëá', packageKeyboard);
});
////////////////////// –ù–∞–≤—á–∞–Ω–Ω—è

////////////////////// TECT
bot.onText(/–ü–µ—Ä–µ–≤—ñ—Ä–∏—Ç–∏ —Å–≤—ñ–π —Ä—ñ–≤–µ–Ω—å/, async (msg) => {
  const chatId = msg.chat.id;

  await bot.sendMessage(chatId, '–û–±–∏—Ä–∞–π—Ç–µ –∫–Ω–æ–ø–∫–∞–º–∏, —â–æ —Ü—ñ–∫–∞–≤–∏—Ç—åüëá', testMenuKeyboard);
});

bot.onText(/–ü–æ—á–∞—Ç–∏ —Ç–µ—Å—Ç/, async (msg) => {
  const chatId = msg.chat.id;
  isTakingTest[chatId] = true;
  currentQuestion[chatId] = 0;
  countTrueAnswers[chatId] = 0;

  await bot.sendMessage(chatId, '–ü–æ—á–∏–Ω–∞—î–º–æ —Ç–µ—Å—Ç –∑ –∞–Ω–≥–ª—ñ–π—Å—å–∫–æ—ó! –î–ª—è –≤–∏—Ö–æ–¥—É –∑ —Ç–µ—Å—Ç—É –Ω–∞—Ç–∏—Å–Ω—ñ—Ç—å –∫–Ω–æ–ø–∫—É "–í–∏–π—Ç–∏ –∑ —Ç–µ—Å—Ç—É".');
  sendQuestion(chatId, questions, currentQuestion, bot);
});

bot.on('message', async (msg) => {
  const chatId = msg.chat.id;

  if (msg.text === '–í–∏–π—Ç–∏ –∑ —Ç–µ—Å—Ç—É') {
    isTakingTest[chatId] = false;
    await bot.sendMessage(chatId, '–í–∏ —É—Å–ø—ñ—à–Ω–æ –≤–∏–π—à–ª–∏ –∑ —Ç–µ—Å—Ç—É.', testMenuKeyboard);
    return;
  }

  if (isTakingTest[chatId]) {
    const questionData = questions[currentQuestion[chatId]];

    if (msg.text === questionData.answer) {
      currentQuestion[chatId]++;
      countTrueAnswers[chatId]++
    } else {
      currentQuestion[chatId]++;
    }

    if (currentQuestion[chatId] < questions.length) {
      sendQuestion(chatId, questions, currentQuestion, bot);
    } else {
      await bot.sendMessage(chatId, `–¢–µ—Å—Ç –∑–∞–≤–µ—Ä—à–µ–Ω–æ! –ö—ñ–ª—å–∫—ñ—Å—Ç—å –ø—Ä–∞–≤–∏–ª—å–Ω–∏—Ö –≤—ñ–¥–ø–æ–≤—ñ–¥–µ–π ${Object.values(countTrueAnswers)}. –î—è–∫—É—é –∑–∞ —É—á–∞—Å—Ç—å!`, testMenuKeyboard);
      isTakingTest[chatId] = false;
    }
  }
});
////////////////////// TECT

bot.onText(/–ó–≤'—è–∑–∞—Ç–∏—Å—è —ñ–∑ –º–µ–Ω–µ–¥–∂–µ—Ä–æ–º/, (msg) => {
  bot.sendMessage(msg.chat.id, "–ë—É–¥—å –ª–∞—Å–∫–∞, –Ω–∞–¥—ñ—à–ª—ñ—Ç—å –≤–∞—à–µ —ñ–º'—è —Ç–∞ –∫–æ–Ω—Ç–∞–∫—Ç–Ω–∏–π –Ω–æ–º–µ—Ä —Ç–µ–ª–µ—Ñ–æ–Ω—É.");

  bot.once('message', (contactMsg) => {
    const contactInfo = contactMsg.text.split(',');

    if (contactInfo.length < 2) {
      bot.sendMessage(contactMsg.chat.id, "–ë—É–¥—å –ª–∞—Å–∫–∞, –≤–≤–µ–¥—ñ—Ç—å –¥–∞–Ω—ñ —É —Ñ–æ—Ä–º–∞—Ç—ñ: –Ü–º'—è, –¢–µ–ª–µ—Ñ–æ–Ω.");
      return;
    }

    const fullName = contactInfo[0].trim();
    const phone = contactInfo[1].trim();

    const contactData = {
      full_name: fullName,
      phone: phone,
    };

    bot.sendMessage(contactMsg.chat.id, `–î—è–∫—É—é! –ú–∏ –∑–≤'—è–∂–µ–º–æ—Å—è –∑ –≤–∞–º–∏ –∑–∞ –Ω–∞—Å—Ç—É–ø–Ω–∏–º –Ω–æ–º–µ—Ä–æ–º: ${phone}`);

    sendToKeyCRM(contactData);
  });
});
